---
title: "ManyPrimates1_Phylogenetic_Analysis"
output:
  html_notebook:
    code_folding: hide
    css: style.css
    theme: paper
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
library(ape)
library(tidyverse)
library(readxl)
library(googledrive)
library(brms)
library(broom)
library(ggthemes)
```


# NOTE
Running the models takes a long time (12h on a HPC) - outputs are too large to put on GitHub (~7GB). If you want to access the model outputs directly, you have to download them via the following code. Files will be saved in `saves/`. 

```{r}
# download zip file from Max Planck cloud storage
library(RCurl)
#
f = CFILE("bfile.zip", mode="wb")
curlPerform(url = "http://www.example.com/bfile.zip", writedata = f@ref)
close(f)


download.file("https://keeper.mpdl.mpg.de/f/e78a9963b58f4a9190d8/?dl=1", 
              destfile = "../saves/saves.zip",
              mode = 'wb' )

# unpack zip file to get .rds files
unzip("../saves/test.zip", exdir = "../saves")
```



# Data processing

## Read in STM data file

```{r}
data <- read_csv("../data/merged_data/ManyPrimates_mp1_merged_data.csv")
```

## Read in species level predictors and scale them.

Species `hamlyns_monkey` and `allens_swamp_monkey` will be excluded from the phylogenetic analysis because we did not find data for some predictors for those species. For `sichuan_snub_nosed_monkey` we actually don't have any experimental data.

```{r}
# drive_download("https://docs.google.com/spreadsheets/d/1RCLvbNWFph6bHvupetx7RDiAu5BWXK6PumgRo44ZoeM/edit#gid=1909432990",
#                path = "../data/species_predictors.xlsx", 
#                overwrite = T)

species_data <- read_xlsx("../data/species_predictors.xlsx", sheet = 1)%>% 
  filter(row_number() <= n()-3)%>% # remove last rows which contained a note
  mutate_if(is.character, tolower)%>%
  filter(species_english != "allens_swamp_monkey",
         species_english != "hamlyns_monkey",
         species_english != "sichuan_snub_nosed_monkey")%>%
  mutate(feeding_budget = as.numeric(feeding_budget),
         day_journey_length= as.numeric(day_journey_length),
         home_range_body_site_ratio = home_range/body_size)%>%
  mutate(resting_time_percent_activitybudget = scale(resting_time_percent_activitybudget, center = T, scale = T),
         home_range_body_site_ratio = scale(home_range_body_site_ratio, center = T, scale = T),
         home_range = scale(home_range, center = T, scale = T),
         feeding_budget = scale(feeding_budget, center = T, scale = T),
         dietary_breadth = scale(dietary_breadth, center = T, scale = T),
         vocal_repertoire = scale(vocal_repertoire, center = T, scale = T),
         group_size = scale(group_size, center = T, scale = T),
         day_journey_length = scale(day_journey_length, center = T, scale = T),
         percent_frugivory = scale(percent_frugivory, center = T, scale = T),
         feeding_budget = scale(feeding_budget, center = T, scale =T))

```

## Merge experimental data with species-level predictors

Exclude species for which we have no species-level data. `Gorilla` has to be re-coded to match the species name in the species-level predictor file.

```{r}
phylo_data <- data %>%
  rename(species_english = species)%>% # create a common column to merge by
  mutate(species_english = ifelse(species_english == "gorilla", "western_gorilla",species_english))%>%
  filter(species_english != "allens_swamp_monkey",
         species_english != "hamlyns_monkey",
         species_english != "sichuan_snub_nosed_monkey")%>%# re-code gorillas to match the species names 
  left_join(species_data)

# check if there are remaining NAs for the predictors

phylo_data %>%
  filter_at(vars(22:33),any_vars(is.na(.)))


```

## Recode the "short/long/medium" condition variable into medium-centred numeric delays:

```{r}
phylo_data <- phylo_data %>%
  mutate(delay = if_else(condition == "short", -1,
                         if_else(condition == "medium", 0, 1)),
         trial = scale(trial, center = T, scale = T))
```

# Phylogenetic tree

Tree-related processing:

 * Read phylogenetic tree from file
 * Check that all species labels in the data also occur as tip labels in the tree
 * Prune any species not in the data from the tree
 * Compute covariance matrix from tree under Brownian motion model

```{r}
tree <- read.tree("../phylo/mp_species.tree")
data_species <- phylo_data$species_english %>% unique
tree_species <- tree$tip.label
stopifnot(length(setdiff(data_species, intersect(tree_species, data_species))) == 0)
tree <- keep.tip(tree, data_species)
A <- vcv.phylo(tree)
```

# Phylogenetic models

## Model 0: Phylogenetic baseline model

```{r}
base_model <- brm(correct ~ delay +
                   (1 + delay + trial | subject_site + site + gr(species_english, cov=A)),
                   data=phylo_data,
                   family=bernoulli(),
                   data2 = list(A = A),
                   chains = 10,
                   iter= 4000,
                   cores= 10,
                   prior = prior(skew_normal(1.4, 2, 3), coef=delay) +
                           prior(normal(0, 1), class=sd, coef=Intercept, group=subject_site) +
                           prior(normal(0, 1), class=sd, coef=Intercept, group=site) +
                           prior(normal(0, 1), class=sd, coef=Intercept, group=species_english) +
                           prior(normal(0, 0.5), class=sd, coef=delay, group=subject_site) +
                           prior(normal(0, 0.5), class=sd, coef=delay, group=site) +
                           prior(normal(0, 0.5), class=sd, coef=delay, group=species_english) +
                           prior(normal(0, 0.5), class=sd, coef=trial, group=subject_site) +
                           prior(normal(0, 0.5), class=sd, coef=trial, group=site) +
                           prior(normal(0, 0.5), class=sd, coef=trial, group=species_english) +
                           prior("lkj(1)", class = "cor")
                )

# summary(base_model)

# base_model <- add_criterion(base_model, "waic")
# 
# base_model %>% saveRDS("../saves/base_model.rds")


base_model <- readRDS("../saves/base_model.rds")

```

## Model 1: Diurnal resting-time

Numeric predictor: `resting_time_percent_activitybudget`.

```{r}
diurnal_resting_model <- brm(correct ~ delay * resting_time_percent_activitybudget +
                   (1 + delay + trial | subject_site + site + gr(species_english, cov=A)),
                   data=phylo_data,
                   family=bernoulli(),
                   data2 = list(A = A),
                   chains = 10,
                   iter= 4000,
                   cores=10,
                   prior = prior(skew_normal(1.4, 2, 3), coef=delay) +
                           prior(normal(0, 1), coef=resting_time_percent_activitybudget) + # test predictor
                           prior(normal(0, 1), coef=`delay:resting_time_percent_activitybudget`) + # test predictor
                           prior(normal(0, 1), class=sd, coef=Intercept, group=subject_site) +
                           prior(normal(0, 1), class=sd, coef=Intercept, group=site) +
                           prior(normal(0, 1), class=sd, coef=Intercept, group=species_english) +
                           prior(normal(0, 0.5), class=sd, coef=delay, group=subject_site) +
                           prior(normal(0, 0.5), class=sd, coef=delay, group=site) +
                           prior(normal(0, 0.5), class=sd, coef=delay, group=species_english) +
                           prior(normal(0, 0.5), class=sd, coef=trial, group=subject_site) +
                           prior(normal(0, 0.5), class=sd, coef=trial, group=site) +
                           prior(normal(0, 0.5), class=sd, coef=trial, group=species_english) +
                           prior("lkj(1)", class = "cor")
                )

#diurnal_resting_model %>% saveRDS("../saves/diurnal_resting_model.rds")

#diurnal_resting_model <- add_criterion(diurnal_resting_model, "waic")

diurnal_resting_model <- readRDS("../saves/diurnal_resting_model.rds")

#summary(diurnal_resting_model)



```

## Model 2: Color vision

Categorical predictor: `color_vision`. 

```{r}
color_vision_model <- brm(correct ~ delay * color_vision + 
                   (1 + delay + trial | subject_site + site + gr(species_english, cov=A)),
                   data=phylo_data, 
                   family=bernoulli(), 
                   data2 = list(A = A), 
                   chains = 10, 
                   iter=4000, 
                   cores=10,
                   prior = prior(skew_normal(1.4, 2, 3), coef=delay) +
                           prior(normal(0, 2), coef=color_visionpolymorphic) + # test predictor
                           prior(normal(0, 2), coef=color_visiontrichromatic) + # test predictor
                           prior(normal(0, 2), coef=`delay:color_visionpolymorphic`) + # test predictor
                           prior(normal(0, 2), coef=`delay:color_visiontrichromatic`) + # test predictor
                           prior(normal(0, 1), class=sd, coef=Intercept, group=subject_site) +
                           prior(normal(0, 1), class=sd, coef=Intercept, group=site) +
                           prior(normal(0, 1), class=sd, coef=Intercept, group=species_english) +
                           prior(normal(0, 0.5), class=sd, coef=delay, group=subject_site) +
                           prior(normal(0, 0.5), class=sd, coef=delay, group=site) +
                           prior(normal(0, 0.5), class=sd, coef=delay, group=species_english) +
                           prior(normal(0, 0.5), class=sd, coef=trial, group=subject_site) +
                           prior(normal(0, 0.5), class=sd, coef=trial, group=site) +
                           prior(normal(0, 0.5), class=sd, coef=trial, group=species_english) +
                           prior("lkj(1)", class = "cor")
                )

#summary(color_vision_model)

color_vision_model <- add_criterion(color_vision_model, "waic")

color_vision_model %>% saveRDS("../saves/color_vision_model.rds")

#color_vision_model <- readRDS("../saves/color_vision_model.rds")
```

## Model 3: Home_range/body size ratio, time spent feeding and range of consumed food items

numerical predictors: `home_range_body_site_ratio`, `feeding_budget` and `dietary_breadth`.

```{r}
home_range_feeding_budget_diet_breath_model <- brm(correct ~ delay * home_range_body_site_ratio + delay * feeding_budget * dietary_breadth +
                   (1 + delay + trial | subject_site + site + gr(species_english, cov=A)),
                   data=phylo_data, 
                   family=bernoulli(), 
                   data2 = list(A = A), 
                   chains = 10, 
                   iter=4000, 
                   cores=10,
                   prior = prior(skew_normal(1.4, 2, 3), coef=delay) +
                           prior(normal(0, 1), coef=home_range_body_site_ratio) + # test predictor
                           prior(normal(0, 1), coef=`delay:dietary_breadth`) + # test predictor
                           prior(normal(0, 1), coef=`delay:home_range_body_site_ratio`) + # test predictor
                           prior(normal(0, 1), coef=`delay:feeding_budget`) + # test predictor
                           prior(normal(0, 1), coef=`delay:feeding_budget:dietary_breadth`) + # test predictor
                           prior(normal(0, 1), coef=dietary_breadth) + # test predictor
                           prior(normal(0, 1), coef=feeding_budget) + # test predictor
                           prior(normal(0, 1), coef=`feeding_budget:dietary_breadth`) + # test predictor
                           prior(normal(0, 1), class=sd, coef=Intercept, group=subject_site) +
                           prior(normal(0, 1), class=sd, coef=Intercept, group=site) +
                           prior(normal(0, 1), class=sd, coef=Intercept, group=species_english) +
                           prior(normal(0, 0.5), class=sd, coef=delay, group=subject_site) +
                           prior(normal(0, 0.5), class=sd, coef=delay, group=site) +
                           prior(normal(0, 0.5), class=sd, coef=delay, group=species_english) +
                           prior(normal(0, 0.5), class=sd, coef=trial, group=subject_site) +
                           prior(normal(0, 0.5), class=sd, coef=trial, group=site) +
                           prior(normal(0, 0.5), class=sd, coef=trial, group=species_english) +
                           prior("lkj(1)", class = "cor")
                )
#summary(home_range_feeding_budget_diet_breath_model)

home_range_feeding_budget_diet_breath_model <- add_criterion(home_range_feeding_budget_diet_breath_model, "waic")

home_range_feeding_budget_diet_breath_model %>% saveRDS("../saves/home_range_feeding_budget_diet_breath_model.rds")

#home_range_feeding_budget_diet_breath_model <- readRDS("../saves/home_range_feeding_budget_diet_breath_model.rds")

```

## Model 3a: Home range

numerical predictor: `home_range`.

```{r}
home_range_model <- brm(correct ~ delay * home_range +
                   (1 + delay + trial | subject_site + site + gr(species_english, cov=A)),
                   data=phylo_data, 
                   family=bernoulli(), 
                   data2 = list(A = A), 
                   chains = 10, 
                   iter=4000, 
                   cores=10,
                   prior = prior(skew_normal(1.4, 2, 3), coef=delay) +
                           prior(normal(0, 1), coef=home_range) + # test predictor
                           prior(normal(0, 1), coef=`delay:home_range`) + # test predictor
                           prior(normal(0, 1), class=sd, coef=Intercept, group=subject_site) +
                           prior(normal(0, 1), class=sd, coef=Intercept, group=site) +
                           prior(normal(0, 1), class=sd, coef=Intercept, group=species_english) +
                           prior(normal(0, 0.5), class=sd, coef=delay, group=subject_site) +
                           prior(normal(0, 0.5), class=sd, coef=delay, group=site) +
                           prior(normal(0, 0.5), class=sd, coef=delay, group=species_english) +
                           prior(normal(0, 0.5), class=sd, coef=trial, group=subject_site) +
                           prior(normal(0, 0.5), class=sd, coef=trial, group=site) +
                           prior(normal(0, 0.5), class=sd, coef=trial, group=species_english) +
                           prior("lkj(1)", class = "cor")
                )
#summary(home_range_model)

home_range_model <- add_criterion(home_range_model, "waic")

home_range_model %>% saveRDS("../saves/home_range_model.rds")

#home_range_model <- readRDS("../saves/home_range_model.rds")

```

## Model 3b: Feeding budget

numerical predictor: `feeding_budget`

```{r}
feeding_budget_model <- brm(correct ~ delay * feeding_budget +
                   (1 + delay + trial | subject_site + site + gr(species_english, cov=A)),
                   data=phylo_data, 
                   family=bernoulli(), 
                   data2 = list(A = A), 
                   chains = 10, 
                   iter=4000, 
                   cores=10,
                   prior = prior(skew_normal(1.4, 2, 3), coef=delay) +
                           prior(normal(0, 1), coef=feeding_budget) + # test predictor
                           prior(normal(0, 1), coef=`delay:feeding_budget`) + # test predictor
                           prior(normal(0, 1), class=sd, coef=Intercept, group=subject_site) +
                           prior(normal(0, 1), class=sd, coef=Intercept, group=site) +
                           prior(normal(0, 1), class=sd, coef=Intercept, group=species_english) +
                           prior(normal(0, 0.5), class=sd, coef=delay, group=subject_site) +
                           prior(normal(0, 0.5), class=sd, coef=delay, group=site) +
                           prior(normal(0, 0.5), class=sd, coef=delay, group=species_english) +
                           prior(normal(0, 0.5), class=sd, coef=trial, group=subject_site) +
                           prior(normal(0, 0.5), class=sd, coef=trial, group=site) +
                           prior(normal(0, 0.5), class=sd, coef=trial, group=species_english) +
                           prior("lkj(1)", class = "cor")
                )
#summary(feeding_budget_model)

feeding_budget_model <- add_criterion(feeding_budget_model, "waic")

feeding_budget_model %>% saveRDS("../saves/feeding_budget_model.rds")

#feeding_budget_model <- readRDS("../saves/feeding_budget_model.rds")

```

## Model 4: Vocal repertoire

Numeric predictor: `vocal_repertoire`. 

```{r}
vocal_repertoire_model <- brm(correct ~ delay * vocal_repertoire + 
                   (1 + delay + trial | subject_site + site + gr(species_english, cov=A)),
                   data=phylo_data, 
                   family=bernoulli(), 
                   data2 = list(A = A), 
                   chains = 10, 
                   iter=4000, 
                   cores=10,
                   prior = prior(skew_normal(1.4, 2, 3), coef=delay) +
                           prior(normal(0, 1), coef=vocal_repertoire) + # test predictor
                           prior(normal(0, 1), coef=`delay:vocal_repertoire`) + # test predictor
                           prior(normal(0, 1), class=sd, coef=Intercept, group=subject_site) +
                           prior(normal(0, 1), class=sd, coef=Intercept, group=site) +
                           prior(normal(0, 1), class=sd, coef=Intercept, group=species_english) +
                           prior(normal(0, 0.5), class=sd, coef=delay, group=subject_site) +
                           prior(normal(0, 0.5), class=sd, coef=delay, group=site) +
                           prior(normal(0, 0.5), class=sd, coef=delay, group=species_english) +
                           prior(normal(0, 0.5), class=sd, coef=trial, group=subject_site) +
                           prior(normal(0, 0.5), class=sd, coef=trial, group=site) +
                           prior(normal(0, 0.5), class=sd, coef=trial, group=species_english) +
                           prior("lkj(1)", class = "cor")
                )

#summary(vocal_repertoire_model)

vocal_repertoire_model <- add_criterion(vocal_repertoire_model, "waic")

vocal_repertoire_model %>% saveRDS("../saves/vocal_repertoire_model.rds")

#vocal_repertoire_model <- readRDS("../saves/vocal_repertoire_model.rds")

```

## Model 5: Dietary breath

Numeric predictor: `dietary_breadth`. 

```{r}
dietary_breadth_model <- brm(correct ~ delay * dietary_breadth + 
                   (1 + delay + trial | subject_site + site + gr(species_english, cov=A)),
                   data=phylo_data, 
                   family=bernoulli(), 
                   data2 = list(A = A), 
                   chains = 10, 
                   iter=4000, 
                   cores=10,
                   prior = prior(skew_normal(1.4, 2, 3), coef=delay) +
                           prior(normal(0, 1), coef=dietary_breadth) + # test predictor
                           prior(normal(0, 1), coef=`delay:dietary_breadth`) + # test predictor
                           prior(normal(0, 1), class=sd, coef=Intercept, group=subject_site) +
                           prior(normal(0, 1), class=sd, coef=Intercept, group=site) +
                           prior(normal(0, 1), class=sd, coef=Intercept, group=species_english) +
                           prior(normal(0, 0.5), class=sd, coef=delay, group=subject_site) +
                           prior(normal(0, 0.5), class=sd, coef=delay, group=site) +
                           prior(normal(0, 0.5), class=sd, coef=delay, group=species_english) +
                           prior(normal(0, 0.5), class=sd, coef=trial, group=subject_site) +
                           prior(normal(0, 0.5), class=sd, coef=trial, group=site) +
                           prior(normal(0, 0.5), class=sd, coef=trial, group=species_english) +
                           prior("lkj(1)", class = "cor")
                )

#summary(dietary_breadth_model)

dietary_breadth_model <- add_criterion(dietary_breadth_model, "waic")

dietary_breadth_model %>% saveRDS("../saves/dietary_breadth_model.rds")

#dietary_breadth_model <- readRDS("../saves/dietary_breadth_model.rds")

```

## Model 6: Group size

Numeric predictor: `group_size`. 

```{r}
group_size_model <- brm(correct ~ delay * group_size + 
                   (1 + delay + trial | subject_site + site + gr(species_english, cov=A)),
                   data=phylo_data, 
                   family=bernoulli(), 
                   data2 = list(A = A), 
                   chains = 10, 
                   iter=4000, 
                   cores=10,
                   prior = prior(skew_normal(1.4, 2, 3), coef=delay) +
                           prior(normal(0, 1), coef=group_size) + # test predictor
                           prior(normal(0, 1), coef=`delay:group_size`) + # test predictor
                           prior(normal(0, 1), class=sd, coef=Intercept, group=subject_site) +
                           prior(normal(0, 1), class=sd, coef=Intercept, group=site) +
                           prior(normal(0, 1), class=sd, coef=Intercept, group=species_english) +
                           prior(normal(0, 0.5), class=sd, coef=delay, group=subject_site) +
                           prior(normal(0, 0.5), class=sd, coef=delay, group=site) +
                           prior(normal(0, 0.5), class=sd, coef=delay, group=species_english) +
                           prior(normal(0, 0.5), class=sd, coef=trial, group=subject_site) +
                           prior(normal(0, 0.5), class=sd, coef=trial, group=site) +
                           prior(normal(0, 0.5), class=sd, coef=trial, group=species_english) +
                           prior("lkj(1)", class = "cor")
                )

#summary(group_size_model)

group_size_model <- add_criterion(group_size_model, "waic")

group_size_model %>% saveRDS("../saves/group_size_model.rds")

#group_size_model <- readRDS("../saves/group_size_model.rds")

```

## Model 7: Day journey length and group size

Numeric predictors: `day_journey_length` and `group_size`. 

```{r}
day_journey_group_size_model <- brm(correct ~ delay * day_journey_length * group_size + 
                   (1 + delay + trial | subject_site + site + gr(species_english, cov=A)),
                   data=phylo_data, 
                   family=bernoulli(), 
                   data2 = list(A = A), 
                   chains = 10, 
                   iter=4000, 
                   cores=10,
                   prior = prior(skew_normal(1.4, 2, 3), coef=delay) +
                           prior(normal(0, 1), coef=group_size) + # test predictor
                           prior(normal(0, 1), coef=day_journey_length) + # test predictor
                           prior(normal(0, 1), coef=`day_journey_length:group_size`) + # test predictor
                           prior(normal(0, 1), coef=`delay:group_size`) + # test predictor
                           prior(normal(0, 1), coef=`delay:day_journey_length`) + # test predictor                     
                           prior(normal(0, 1), coef=`delay:day_journey_length:group_size`) + # test predictor
                           prior(normal(0, 1), class=sd, coef=Intercept, group=subject_site) +
                           prior(normal(0, 1), class=sd, coef=Intercept, group=site) +
                           prior(normal(0, 1), class=sd, coef=Intercept, group=species_english) +
                           prior(normal(0, 0.5), class=sd, coef=delay, group=subject_site) +
                           prior(normal(0, 0.5), class=sd, coef=delay, group=site) +
                           prior(normal(0, 0.5), class=sd, coef=delay, group=species_english) +
                           prior(normal(0, 0.5), class=sd, coef=trial, group=subject_site) +
                           prior(normal(0, 0.5), class=sd, coef=trial, group=site) +
                           prior(normal(0, 0.5), class=sd, coef=trial, group=species_english) +
                           prior("lkj(1)", class = "cor")
                )

#summary(day_journey_group_size_model)

day_journey_group_size_model <- add_criterion(day_journey_group_size_model, "waic")

day_journey_group_size_model %>% saveRDS("../saves/day_journey_group_size_model.rds")

#day_journey_group_size_model <- readRDS("../saves/day_journey_group_size_model.rds")

```

## Model 7a: Day journey length

Numeric predictor: `day_journey_length`.

```{r}
day_journey_model <- brm(correct ~ delay * day_journey_length + 
                   (1 + delay + trial | subject_site + site + gr(species_english, cov=A)),
                   data=phylo_data, 
                   family=bernoulli(), 
                   data2 = list(A = A), 
                   chains = 10, 
                   iter=4000, 
                   cores=10,
                   prior = prior(skew_normal(1.4, 2, 3), coef=delay) +
                           prior(normal(0, 1), coef=day_journey_length) + # test predictor
                           prior(normal(0, 1), coef=`delay:day_journey_length`) + # test predictor            
                           prior(normal(0, 1), class=sd, coef=Intercept, group=subject_site) +
                           prior(normal(0, 1), class=sd, coef=Intercept, group=site) +
                           prior(normal(0, 1), class=sd, coef=Intercept, group=species_english) +
                           prior(normal(0, 0.5), class=sd, coef=delay, group=subject_site) +
                           prior(normal(0, 0.5), class=sd, coef=delay, group=site) +
                           prior(normal(0, 0.5), class=sd, coef=delay, group=species_english) +
                           prior(normal(0, 0.5), class=sd, coef=trial, group=subject_site) +
                           prior(normal(0, 0.5), class=sd, coef=trial, group=site) +
                           prior(normal(0, 0.5), class=sd, coef=trial, group=species_english) +
                           prior("lkj(1)", class = "cor")
                )

#summary(day_journey_model)

day_journey_model <- add_criterion(day_journey_model, "waic")

day_journey_model %>% saveRDS("../saves/day_journey_model.rds")

#day_journey_model <- readRDS("../saves/day_journey_model.rds")

```

## Model 8: Percent frugivory and terrestriality

Numeric predictor: `percent_frugivory`. Categorical predictor and `terrestriality`. 

```{r}
frugivory_terrestriality_model <- brm(correct ~ delay * percent_frugivory * terrestriality + 
                   (1 + delay + trial | subject_site + site + gr(species_english, cov=A)),
                   data=phylo_data, 
                   family=bernoulli(), 
                   data2 = list(A = A), 
                   chains = 10, 
                   iter=4000, 
                   cores=10,
                   prior = prior(skew_normal(1.4, 2, 3), coef=delay) +
                           prior(normal(0, 2), coef=terrestrialityterrestrial) + # test predictor
                           prior(normal(0, 1), coef=percent_frugivory) + # test predictor
                           prior(normal(0, 2), coef=`percent_frugivory:terrestrialityterrestrial`) + # test predictor
                           prior(normal(0, 2), coef=`delay:terrestrialityterrestrial`) + # test predictor
                           prior(normal(0, 1), coef=`delay:percent_frugivory`) + # test predictor                     
                           prior(normal(0, 2), coef=`delay:percent_frugivory:terrestrialityterrestrial`) + # test predictor
                           prior(normal(0, 1), class=sd, coef=Intercept, group=subject_site) +
                           prior(normal(0, 1), class=sd, coef=Intercept, group=site) +
                           prior(normal(0, 1), class=sd, coef=Intercept, group=species_english) +
                           prior(normal(0, 0.5), class=sd, coef=delay, group=subject_site) +
                           prior(normal(0, 0.5), class=sd, coef=delay, group=site) +
                           prior(normal(0, 0.5), class=sd, coef=delay, group=species_english) +
                           prior(normal(0, 0.5), class=sd, coef=trial, group=subject_site) +
                           prior(normal(0, 0.5), class=sd, coef=trial, group=site) +
                           prior(normal(0, 0.5), class=sd, coef=trial, group=species_english) +
                           prior("lkj(1)", class = "cor")
                )

#summary(frugivory_terrestriality_model)

frugivory_terrestriality_model <- add_criterion(frugivory_terrestriality_model, "waic")

frugivory_terrestriality_model %>% saveRDS("../saves/frugivory_terrestriality_model.rds")

#frugivory_terrestriality_model <- readRDS("../saves/frugivory_terrestriality_model.rds")

```

## Model 8a: Percent frugivory

Numeric predictor: `percent_frugivory`.

```{r}
frugivory_model <- brm(correct ~ delay * percent_frugivory + 
                   (1 + delay + trial | subject_site + site + gr(species_english, cov=A)),
                   data=phylo_data, 
                   family=bernoulli(), 
                   data2 = list(A = A), 
                   chains = 10, 
                   iter=4000, 
                   cores=10,
                   prior = prior(skew_normal(1.4, 2, 3), coef=delay) +
                           prior(normal(0, 1), coef=percent_frugivory) + # test predictor
                           prior(normal(0, 1), coef=`delay:percent_frugivory`) + # test predictor              
                           prior(normal(0, 1), class=sd, coef=Intercept, group=subject_site) +
                           prior(normal(0, 1), class=sd, coef=Intercept, group=site) +
                           prior(normal(0, 1), class=sd, coef=Intercept, group=species_english) +
                           prior(normal(0, 0.5), class=sd, coef=delay, group=subject_site) +
                           prior(normal(0, 0.5), class=sd, coef=delay, group=site) +
                           prior(normal(0, 0.5), class=sd, coef=delay, group=species_english) +
                           prior(normal(0, 0.5), class=sd, coef=trial, group=subject_site) +
                           prior(normal(0, 0.5), class=sd, coef=trial, group=site) +
                           prior(normal(0, 0.5), class=sd, coef=trial, group=species_english) +
                           prior("lkj(1)", class = "cor")
                )

#summary(frugivory_model)

frugivory_model <- add_criterion(frugivory_model, "waic")

frugivory_model %>% saveRDS("../saves/frugivory_model.rds")

#frugivory_model <- readRDS("../saves/frugivory_model.rds")

```

## Model 8b: Terrestriality

Categorical predictor and `terrestriality`. 

```{r}
terrestriality_model <- brm(correct ~ delay * terrestriality + 
                   (1 + delay + trial | subject_site + site + gr(species_english, cov=A)),
                   data=phylo_data, 
                   family=bernoulli(), 
                   data2 = list(A = A), 
                   chains = 10, 
                   iter=4000, 
                   cores=10,
                   prior = prior(skew_normal(1.4, 2, 3), coef=delay) +
                           prior(normal(0, 2), coef=terrestrialityterrestrial) + # test predictor
                           prior(normal(0, 2), coef=`delay:terrestrialityterrestrial`) + # test predictor
                           prior(normal(0, 1), class=sd, coef=Intercept, group=subject_site) +
                           prior(normal(0, 1), class=sd, coef=Intercept, group=site) +
                           prior(normal(0, 1), class=sd, coef=Intercept, group=species_english) +
                           prior(normal(0, 0.5), class=sd, coef=delay, group=subject_site) +
                           prior(normal(0, 0.5), class=sd, coef=delay, group=site) +
                           prior(normal(0, 0.5), class=sd, coef=delay, group=species_english) +
                           prior(normal(0, 0.5), class=sd, coef=trial, group=subject_site) +
                           prior(normal(0, 0.5), class=sd, coef=trial, group=site) +
                           prior(normal(0, 0.5), class=sd, coef=trial, group=species_english) +
                           prior("lkj(1)", class = "cor")
                )

#summary(terrestriality_model)

terrestriality_model <- add_criterion(terrestriality_model, "waic")

terrestriality_model %>% saveRDS("../saves/terrestriality_model.rds")

#terrestriality_model <- readRDS("../saves/terrestriality_model.rds")

```

## Model 9: Diet diversity

Categorical predictor: `diet_diversity`. 

```{r}
diet_diversity_model <- brm(correct ~ delay * diet_diversity + 
                   (1 + delay + trial | subject_site + site + gr(species_english, cov=A)),
                   data=phylo_data, 
                   family=bernoulli(), 
                   data2 = list(A = A), 
                   chains = 10, 
                   iter=4000, 
                   cores=10,
                   prior = prior(skew_normal(1.4, 2, 3), coef=delay) +
                           prior(normal(0, 2), coef=diet_diversityfolivore_frugivore) + # test predictor
                           prior(normal(0, 2), coef=diet_diversityfrugivore) + # test predictor
                           prior(normal(0, 2), coef=diet_diversitygummivore) + # test predictor
                           prior(normal(0, 2), coef=diet_diversityinsectivore_frugivore) + # test predictor
                           prior(normal(0, 2), coef=diet_diversityomnivore) + # test predictor
                           prior(normal(0, 2), coef=`delay:diet_diversityfolivore_frugivore`) + # test predictor
                           prior(normal(0, 2), coef=`delay:diet_diversityfrugivore`) + # test predictor
                           prior(normal(0, 2), coef=`delay:diet_diversitygummivore`) + # test predictor
                           prior(normal(0, 2), coef=`delay:diet_diversityinsectivore_frugivore`) + # test predictor
                           prior(normal(0, 2), coef=`delay:diet_diversityomnivore`) + # test predictor
                           prior(normal(0, 1), class=sd, coef=Intercept, group=subject_site) +
                           prior(normal(0, 1), class=sd, coef=Intercept, group=site) +
                           prior(normal(0, 1), class=sd, coef=Intercept, group=species_english) +
                           prior(normal(0, 0.5), class=sd, coef=delay, group=subject_site) +
                           prior(normal(0, 0.5), class=sd, coef=delay, group=site) +
                           prior(normal(0, 0.5), class=sd, coef=delay, group=species_english) +
                           prior(normal(0, 0.5), class=sd, coef=trial, group=subject_site) +
                           prior(normal(0, 0.5), class=sd, coef=trial, group=site) +
                           prior(normal(0, 0.5), class=sd, coef=trial, group=species_english) +
                           prior("lkj(1)", class = "cor")
                )
#summary(diet_diversity_model)

diet_diversity_model <- add_criterion(diet_diversity_model, "waic")

diet_diversity_model %>% saveRDS("../saves/diet_diversity_model.rds")

#diet_diversity_model <- readRDS("../saves/diet_diversity_model.rds")
```

# Model comparison

## Models from modelling challenge

```{r}
# Compute WAIC scores and SE
comp <-  loo_compare(
  base_model, 
  diurnal_resting_model,
  color_vision_model,
  home_range_feeding_budget_diet_breath_model,
  vocal_repertoire_model,
  dietary_breadth_model,
  group_size_model,
  day_journey_group_size_model,
  frugivory_terrestriality_model,
  diet_diversity_model,
  criterion = "waic")%>%
  as_tibble(rownames = "model")
  
# Compute WAIC weights
weights <- model_weights(
  base_model, 
  diurnal_resting_model,
  color_vision_model,
  home_range_feeding_budget_diet_breath_model,
  vocal_repertoire_model,
  dietary_breadth_model,
  group_size_model,
  day_journey_group_size_model,
  frugivory_terrestriality_model,
  diet_diversity_model, weights = "waic")%>%
  as_tibble() %>% 
  rename(weight = value) %>% 
  mutate(model  = c("base_model", 
                    "diurnal_resting_model",
                    "color_vision_model",
                    "home_range_feeding_budget_diet_breath_model",
                    "vocal_repertoire_model",
                    "dietary_breadth_model",
                    "group_size_model",
                    "day_journey_group_size_model",
                    "frugivory_terrestriality_model",
                    "diet_diversity_model"),
         weight = weight %>% round(digits = 2)) %>% 
  select(model, weight) 


# Combine weights and scores
model_comparison <- comp %>%
  select(model,waic, se_waic)%>%
  left_join(weights)%>%
  arrange(desc(weight))

write_csv(model_comparison, "../saves/model_comparison.csv")

model_comparison <- read_csv("../saves/model_comparison.csv")

model_comparison
```
## Exploratory analysis:Include main effects models for all predictors

Some models were submitted with interaction terms between variables. The additional models below were built so that each predictor that was submitted as part of an interaction is also included in a model with only that predictor. 

```{r}
# Compute WAIC scores and SE
comp_exp <-  loo_compare(
  base_model,    # models from modelling challnege
  diurnal_resting_model,
  color_vision_model,
  home_range_feeding_budget_diet_breath_model,
  vocal_repertoire_model,
  dietary_breadth_model,
  group_size_model,
  day_journey_group_size_model,
  frugivory_terrestriality_model,
  diet_diversity_model,
  
  home_range_model,      # main effects models 
  feeding_budget_model,
  day_journey_model,
  frugivory_model,
  terrestriality_model,
  
  criterion = "waic")%>%
  as_tibble(rownames = "model")
  
# Compute WAIC weights
weights_exp <- model_weights(
  base_model, 
  diurnal_resting_model,
  color_vision_model,
  home_range_feeding_budget_diet_breath_model,
  vocal_repertoire_model,
  dietary_breadth_model,
  group_size_model,
  day_journey_group_size_model,
  frugivory_terrestriality_model,
  diet_diversity_model, 
  home_range_model,
  feeding_budget_model,
  day_journey_model,
  frugivory_model,
  terrestriality_model,
  weights = "waic")%>%
  as_tibble() %>% 
  rename(weight = value) %>% 
  mutate(model  = c("base_model", 
                    "diurnal_resting_model",
                    "color_vision_model",
                    "home_range_feeding_budget_diet_breath_model",
                    "vocal_repertoire_model",
                    "dietary_breadth_model",
                    "group_size_model",
                    "day_journey_group_size_model",
                    "frugivory_terrestriality_model",
                    "diet_diversity_model",
                    "home_range_model",
                    "feeding_budget_model",
                    "day_journey_model",
                    "frugivory_model",
                    "terrestriality_model"),
         weight = weight %>% round(digits = 2)) %>% 
  select(model, weight) 


# Combine weights and scores
model_comparison_exp <- comp_exp %>%
  select(model,waic, se_waic)%>%
  left_join(weights_exp)%>%
  arrange(desc(weight))

#write_csv(model_comparison_exp, "../saves/model_comparison_exp.csv")

#model_comparison_exp <- read_csv("../saves/model_comparison_exp.csv")

model_comparison_exp
```

# Visualize winning models and baseline

correlate species estimates from model with predictor

```{r}
model_draws <-  bind_rows(
  dietary_breadth_model %>% posterior_samples(pars = c("b_delay","b_dietary_breadth","b_delay:dietary_breadth"))%>%
    rename(delay = b_delay,
           predictor = b_dietary_breadth,
           interaction = `b_delay:dietary_breadth`)%>%
    mutate(model= "dietary_breadth"),
  vocal_repertoire_model%>% posterior_samples(pars = c("b_delay","b_vocal_repertoire","b_delay:vocal_repertoire"))%>%
    rename(delay = b_delay,
           predictor = b_vocal_repertoire,
           interaction = `b_delay:vocal_repertoire`)%>%
    mutate(model= "vocal_repertoire"),
  base_model%>% posterior_samples(pars = c("b_delay"))%>%
    rename(delay = b_delay)%>%
    mutate(model= "baseline")
)%>%
  pivot_longer(names_to = "estimate", values_to = "value", cols = c(delay,predictor,interaction ))

model_draws %>%
  ggplot(.,aes(x = value, fill = model))+
  geom_vline(xintercept = 0, lty = 2, col = "grey")+
  geom_density(alpha = .5)+
  facet_grid(model~estimate)+
  theme_minimal()+
  scale_fill_colorblind()
```


