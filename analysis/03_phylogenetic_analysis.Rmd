---
title: "ManyPrimates1_Phylogenetic_Analysis"
output:
  html_notebook:
    code_folding: hide
    css: style.css
    theme: paper
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
library(ape)
library(tidyverse)
library(readxl)
library(googledrive)
library(brms)
```

# Read in STM data file

```{r}
data <- read_csv("../data/merged_data/ManyPrimates_mp1_merged_data.csv")
```
```{r}
# drive_download("https://docs.google.com/spreadsheets/d/1RCLvbNWFph6bHvupetx7RDiAu5BWXK6PumgRo44ZoeM/edit#gid=1909432990",
#                path = "../data/species_predictors.xlsx", 
#                overwrite = T)

species_data <- read_xlsx("../data/species_predictors.xlsx", sheet = 1)%>% 
  filter(row_number() <= n()-3)%>% # remove last rows which contained a note
  mutate_if(is.character, tolower)

```

Merge experimental data with species-level predictors

Species `hamlyns_monkey` and `allens_swamp_monkey` will be excluded from the phylogenetic analysis because we did not find data for some predictors for those species. For `sichuan_snub_nosed_monkey` we actually don't have any experimental data.

```{r}
phylo_data <- data %>%
  rename(species_english = species)%>% # create a common column to merge by
  mutate(species_english = ifelse(species_english == "gorilla", "western_gorilla",species_english)) %>%# re-code gorillas to match the species names 
  left_join(species_data)%>%
  filter(species_english != "allens_swamp_monkey",
         species_english != "hamlyns_monkey",
         species_english != "sichuan_snub_nosed_monkey")

# check if there are remaining NAs for the predictors

phylo_data %>%
  filter_at(vars(22:33),any_vars(is.na(.)))


```

Recode the "short/long/medium" condition variable into medium-centred numeric delays:

```{r}
phylo_data <- phylo_data %>%
  mutate(delay = if_else(condition == "short", -0.15,
                         if_else(condition == "medium", 0, 15)))
```

Tree-related processing:

 * Read phylogenetic tree from file
 * Check that all species labels in the data also occur as tip labels in the tree
 * Prune any species not in the data from the tree
 * Compute covariance matrix from tree under Brownian motion model

```{r}
tree <- read.tree("../phylo/mp_species.tree")
data_species <- phylo_data$species_english %>% unique
tree_species <- tree$tip.label
stopifnot(length(setdiff(data_species, intersect(tree_species, data_species))) == 0)
tree <- keep.tip(tree, data_species)
A <- vcv.phylo(tree)
```

Run phylogenetic model:

```{r}
phylo_model <- brm(correct ~ delay + (1 + delay + trial | subject_site + site + gr(species_english, cov=A)),
                   data=phylo_data, family=bernoulli(), data2 = list(A = A), chains = 4, iter=4000, cores=4,
                   prior = prior(skew_normal(1.4, 2, 3), coef=delay) +
                           prior(normal(0, 1), class=sd, coef=Intercept, group=subject_site) +
                           prior(normal(0, 1), class=sd, coef=Intercept, group=site) +
                           prior(normal(0, 1), class=sd, coef=Intercept, group=species_english) +
                           prior(normal(0, 0.5), class=sd, coef=delay, group=subject_site) +
                           prior(normal(0, 0.5), class=sd, coef=delay, group=site) +
                           prior(normal(0, 0.5), class=sd, coef=delay, group=species_english) +
                           prior(normal(0, 0.5), class=sd, coef=trial, group=subject_site) +
                           prior(normal(0, 0.5), class=sd, coef=trial, group=site) +
                           prior(normal(0, 0.5), class=sd, coef=trial, group=species_english) +
                           prior("lkj(1)", class = "cor")
                )

summary(phylo_model)
```
